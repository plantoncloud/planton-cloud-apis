syntax = "proto3";

package cloud.planton.apis.iac.v1.stackjob.model.progress.snapshot;

import "cloud/planton/apis/iac/v1/stackjob/enums/pulumidiagnosticeventseveritytype/pulumi_diagnostic_event_severity_type.proto";
import "cloud/planton/apis/iac/v1/stackjob/model/state.proto";

//complete snapshot of a stack-job log
message StackJobProgressSnapshot {
  //unique identifier for the snapshot(ulid)
  string id = 1;
  //id of the stack-job
  string stack_job_id = 2;
  //status of the stack-job
  cloud.planton.apis.iac.v1.stackjob.model.StackJobStatusProgressStatus job_progress = 3;
  //snapshot of 'pulumi refresh' operation
  StackJobProgressPulumiOperationSnapshot refresh_snapshot = 4;
  //snapshot of 'pulumi preview'(apply) operation
  StackJobProgressPulumiOperationSnapshot apply_preview_snapshot = 5;
  //snapshot of 'pulumi preview'(destroy) operation
  StackJobProgressPulumiOperationSnapshot destroy_preview_snapshot = 6;
  //snapshot of 'pulumi up' operation
  StackJobProgressPulumiOperationSnapshot apply_snapshot = 7;
  //snapshot of 'pulumi destroy' operation
  StackJobProgressPulumiOperationSnapshot destroy_snapshot = 8;
}

//snapshot of the pulumi operation
message StackJobProgressPulumiOperationSnapshot {
  // unique identifier for the operation-summary.
  //this is in the format "<stack-job-id>-<operation-type>".
  //this attribute acts as a binder between the stack-job-progress-snapshot entity and
  // pulumi-operation-snapshot entity in database and is unused otherwise.
  string id = 1;

  //status of the pulumi operation
  cloud.planton.apis.iac.v1.stackjob.model.StackJobStatusPulumiOperationStatus operation_status = 2;

  //prelude events generated by pulumi engine
  PulumiOperationPreludeSnapshot prelude = 3;
  //resource-changes generated by pulumi engine
  PulumiOperationResourceChangesSnapshot resource_changes = 4;
  //resource diff generated by pulumi engine
  PulumiOperationDiffSnapshot diff = 5;
  //diagnostic events generated by pulumi engine
  PulumiOperationDiagnosticsSnapshot diagnostics = 6;
  //summary event generated by pulumi engine
  PulumiOperationSummarySnapshot summary = 7;
}

message PulumiOperationPreludeSnapshot {
  repeated string prelude_messages = 1;
}

message PulumiOperationResourceChangesSnapshot {
  map<string,PulumiOperationResourceChangesSnapshotRow> urn_to_row_map = 1;
}

message PulumiOperationDiffSnapshot {
  repeated string resource_diffs = 1;
}

message PulumiOperationDiagnosticsSnapshot {
  repeated PulumiOperationDiagnosticMessage diagnostic_messages = 1;
}

message PulumiOperationSummarySnapshot {
  int32 duration_seconds = 1;
  int32 unchanged_resource_count = 2;
  int32 create_resource_count = 3;
  int32 update_resource_count = 4;
  int32 delete_resource_count = 5;
  int32 replace_resource_count = 6;
}

message PulumiOperationResourceChangesSnapshotRow {
  string resource_kind = 1;
  string resource_name = 2;
  string status = 3;
  bool is_done = 4;
  bool is_failed = 5;
  int64 elapsed_duration_seconds = 6;
}

// pulumi operation diagnostic message
message PulumiOperationDiagnosticMessage {
  //indicates the severity of the message
  cloud.planton.apis.iac.v1.stackjob.enums.pulumidiagnosticeventseveritytype.PulumiDiagnosticEventSeverityType severity = 1;
  // urn of the resource for which the message belongs to
  string resource_urn = 2;
  //diagnostic message
  string message = 3;
}
